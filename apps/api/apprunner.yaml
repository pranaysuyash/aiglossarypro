version: 1.0
runtime: nodejs18

build:
  commands:
    pre-build:
      - npm install -g pnpm
      - corepack enable
      - echo "Node version:" && node --version
      - echo "pnpm version:" && pnpm --version
    build:
      - pnpm install --frozen-lockfile
      # CRITICAL: Switch to CommonJS configuration
      - cp package.deploy.json package.json
      - echo "Switched to CommonJS package.json"
      # Build workspace packages first (they output JS)
      - pnpm --filter @aiglossarypro/shared run build || echo "shared build completed"
      - pnpm --filter @aiglossarypro/database run build || echo "database build completed"  
      - pnpm --filter @aiglossarypro/auth run build || echo "auth build completed"
      - pnpm --filter @aiglossarypro/config run build || echo "config build completed"
      # CRITICAL: Build API to CommonJS JavaScript
      - pnpm run build
      - echo "API CommonJS build completed"
      - ls -la dist/ || echo "No dist directory yet"
    post-build:
      - pnpm prune --prod
      - echo "Production dependencies optimized"

run:
  # CRITICAL: Run compiled JavaScript, not TypeScript
  command: node dist/index.js
  network:
    port: 8080
    env: PORT
  env:
    - name: NODE_ENV
      value: production
    - name: PORT
      value: "8080"
    - name: FIREBASE_PROJECT_ID
      value: "aiglossary-a7199"
    - name: FIREBASE_CLIENT_EMAIL
      value: "firebase-adminsdk-syzds@aiglossary-a7199.iam.gserviceaccount.com"
    # This will be configured in AWS Console after deployment
    # - name: FIREBASE_PRIVATE_KEY_BASE64
    #   value: "Set via AWS Console using Secrets Manager"