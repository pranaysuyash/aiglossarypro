version: 1.0
runtime: nodejs18

build:
  commands:
    pre-build:
      - npm install -g pnpm
      - corepack enable
      - echo "Node version:" && node --version
      - echo "pnpm version:" && pnpm --version
    build:
      - pnpm install --frozen-lockfile
      # Build workspace packages (they're already configured for ESM)
      - pnpm --filter @aiglossarypro/shared run build || echo "shared build completed"
      - pnpm --filter @aiglossarypro/database run build || echo "database build completed"  
      - pnpm --filter @aiglossarypro/auth run build || echo "auth build completed"
      - pnpm --filter @aiglossarypro/config run build || echo "config build completed"
      # Install tsx for running TypeScript directly
      - pnpm add tsx
      - echo "Build completed successfully"
    post-build:
      - echo "Production dependencies ready"

run:
  runtime-version: 18
  command: ./node_modules/.bin/tsx src/index.ts
  network:
    port: 8080
    env: PORT
  env:
    - name: NODE_ENV
      value: production
    - name: PORT
      value: "8080"
    - name: FIREBASE_PROJECT_ID
      value: "aiglossary-a7199"
    - name: FIREBASE_CLIENT_EMAIL
      value: "firebase-adminsdk-syzds@aiglossary-a7199.iam.gserviceaccount.com"
    # This will be configured in AWS Console after deployment
    # - name: FIREBASE_PRIVATE_KEY_BASE64
    #   value: "Set via AWS Console using Secrets Manager">