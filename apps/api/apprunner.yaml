version: 1.0
runtime: nodejs18

build:
  commands:
    pre-build:
      - npm install -g pnpm
      - corepack enable
      - echo "Node version:" && node --version
      - echo "pnpm version:" && pnpm --version
    build:
      - pnpm install --frozen-lockfile
      # Debug: Check files before package swap
      - echo "=== BEFORE PACKAGE SWAP ==="
      - ls -la package*.json
      - cat package.json | grep -E "(type|main|scripts)" || echo "No match"
      
      # CRITICAL: Switch to CommonJS configuration
      - cp package.deploy.json package.json
      - echo "=== AFTER PACKAGE SWAP ==="
      - ls -la package*.json
      - cat package.json | grep -E "(type|main|scripts)" || echo "No match"
      
      # Build workspace packages first
      - pnpm --filter @aiglossarypro/shared run build || echo "shared build completed"
      - pnpm --filter @aiglossarypro/database run build || echo "database build completed"  
      - pnpm --filter @aiglossarypro/auth run build || echo "auth build completed"
      - pnpm --filter @aiglossarypro/config run build || echo "config build completed"
      
      # Debug: Check TypeScript config
      - echo "=== TYPESCRIPT CONFIG CHECK ==="
      - ls -la tsconfig*.json
      - cat tsconfig.deploy.json || echo "tsconfig.deploy.json not found"
      
      # CRITICAL: Build API to CommonJS (with debugging)
      - echo "=== STARTING API BUILD ==="
      - pnpm run build || (echo "BUILD FAILED" && exit 1)
      - echo "=== API BUILD COMPLETED ==="
      
      # Verify build output
      - echo "=== VERIFYING BUILD OUTPUT ==="
      - ls -la dist/ || echo "No dist directory found"
      - ls -la dist/*.js || echo "No JS files in dist"
      - head -20 dist/index.js || echo "Cannot read dist/index.js"
      
    post-build:
      - echo "Production dependencies ready - v3 with fixed install"
      # CRITICAL: Remove existing node_modules and reinstall for production
      - echo "Setting up production dependencies..."
      - rm -rf node_modules
      # Use full pnpm install (not --prod) to ensure all deps are available
      - pnpm install --no-frozen-lockfile
      - echo "Checking node_modules installation..."
      - ls -la node_modules | head -10
      - echo "Production dependencies installed successfully"

run:
  # Direct node execution - App Runner doesn't support complex shell commands
  command: node dist/index.js
  network:
    port: 8080
    env: PORT
  env:
    - name: NODE_ENV
      value: production
    - name: PORT
      value: "8080"
    # Production environment variables
    - name: DATABASE_URL
      value: "postgresql://neondb_owner:npg_9dlJKInqoT1w@ep-wandering-morning-a5u0szvw.us-east-2.aws.neon.tech/neondb?sslmode=require"
    - name: SESSION_SECRET
      value: "JCmY1YTJ2lXuEKhHgKZURZfub9S7WNQgy5Om2NFDdWu3dg0CtqB7wQGyXHzQG2sqDVAkGE9H9ual6uc1cVn8LA=="
    - name: JWT_SECRET
      value: "JCmY1YTJ2lXuEKhHgKZURZfub9S7WNQgy5Om2NFDdWu3dg0CtqB7wQGyXHzQG2sqDVAkGE9H9ual6uc1cVn8LA=="
    # Enable simple auth as fallback
    - name: SIMPLE_AUTH_ENABLED
      value: "true"
    # Firebase auth - ENABLED with proper credentials
    - name: FIREBASE_PROJECT_ID
      value: "aiglossarypro"
    - name: FIREBASE_CLIENT_EMAIL
      value: "firebase-adminsdk-fbsvc@aiglossarypro.iam.gserviceaccount.com"
    - name: FIREBASE_PRIVATE_KEY_BASE64
      value: "LS0tLS1CRUdJTiBQUklWQVRFIEtFWS0tLS0tCk1JSUV2UUlCQURBTkJna3Foa2lHOXcwQkFRRUZBQVNDQktjd2dnU2pBZ0VBQW9JQkFRQ0wyME9wZlJ0bG8rQVAKWUtURzBWbDgveHdlVWRUbnZ4a205eWNyUXpPRHhMVVNWSlRacHN1NGRhS0N3ZUtiVUtTM0RiZEhQYTJEMUFZSQo1b3g0a2UvcytSWWxEbm9mR1hzNnV1QXNWaEE4ZkxUMDVSSEhoNHVZSG5aT205N3lOREl6MUJvYjZFM0JvWjdJCmMyY2VaeXdyYVpaTDBRUzZRbi9kT1RabzNua09vOEhMeXlTL1ZnYmYvNk5vd0g4YldTdHlWZnV4cmVrYzdNOXcKN2w1czlhS0N0cHo1ZFROajAxOG1VdmpHZDNWS0kwQ0R5NmVoQkVTdjVYV3FOdTYvbXB1dWhJUmx2MHdFK2lhRwpwTXlzYUt1cUUyaTRzbk1RTzVWNmFnNU9pVk1kNnNPY1I4ZmtrMXBHMHJUZlhlaHpHVTlXbUh1NUdheGJRU1UwCjFXNnlKU1ZmQWdNQkFBRUNnZ0VBRTZmQXBpRE5pV2JURmdZc2tqNlkxNDdZNmsvdzNwTUdXMm9QeUs0OG5xKzIKRFBuekkzV2tHdXY1WjJ3TlIydTVnbnA4Z0Jna2V5c0FvQjZhcmxWQVJXc3FXQkhsU3RxZmJYMFhCVlFoR3djaAp2V3MyS1BjZFFNZERORUFHd0w1aU1kT0V5ZGhIbVVkNEU4N1lOcmNrUjRPaTJrdnBZSzM0MzJQcmlDaUFGZlRyCmxLQmQ2bHdaTHU5c0huVnlWVGdzNmZ0Vlpla3RadmkxY2drOUZzRUJsK0IzUGxsSXpUSEJSWHJBczBqV2lTYUwKRE9HbVk2eC92T2lFQnRQeWJIenNkNVN5c1BpblF2MEluYnRNSzBKeGV4Skh4ME1uQ3VKYjdUWHhheUdxb3Z5UAoyQTVsMG9nd3lDNFV5K2FuRW5SMWRiSWF2cDdtZ2xURjA0dzVCVmhZUFFLQmdRREJMUWJCVG9EaG1meWVDUkZ0CmlhSmJFYlFYbmNyc2xrbCtaVGErM0U1d054ZUJoazJBd3VlVVlRUDhGbWhQRkc5QS9GVGE5ZW8reGZldjhQUFIKVk9SaWxCNTFkczg2ZkhycEhTUTM3bGJVMnl1T2VRRE5aM0hjVjBrYm1UVFBUM040TEVQOW9mdFFUTURuWFo4LwpSeEJ5YkJCTEc0bEw4YktmWmdGeCszVVZuUUtCZ1FDNVZ4blFNWjBxb3dsZTJOMlBmS2pmRTRtdmRNYVY5ZWpjClFzenp0bk5uNmZwdnFITXliWHhyeHVmeXh5dEx5YjlqWlhyWmxYQmxnOXhmK1EwTVFYRUFuL1c3MWw4eW9SRUUKZnV1VUJLb01Xb21NNk9odmF1Z1VkQ09WdjN5U3I2YUNFL2VRWGMzaHY0SzMwRld5TjFGNlpRdzZpN082T1MvTApqSW1Dbi85VUt3S0JnSDlOb2ZjQU9oVHllclRXK3dJNXdxSExYK2gwVjBka254aEpzVE5FVWZqSGhaa1pIYmd1Ck9aamgrbE5GblFZSVRHMENIUldUSEFTMFI4OU50aEFNcHRtRURUS1IwbTBUblpoRVdScjIyWWc2eTFCLzA1U0oKaUZLUnZ4OE43dXh6eW4rMmhEUUFiSEwxc2VhSEh5di9OQXFEeHBVSWw0bFJ4Y29mMmZINHFhZE5Bb0dBYXQySwpDTDFTdmU3YnpGQ0hEK0QxRGdzWjdJME1wQkx5Zlc0VzlyOVFzNjM1dE1BUURCZU5FaWZTUGU0UlROVzdBUGpXCmFQYjlvOHJ3R25aank1bEFLdmdRbklueXdpS1V5VjdWUHJlaHhSVy9FZnlKYVJUZlZFdlM2TmxNWHRmZ3prZnQKQ3RUTGpVcjdlRGtyOEdKdEhJRi9GNUxOd3FhT3BITVlKclZTWjVrQ2dZRUFoWE1LS2VncGY2ZGNENTNUQUFmegppWlNNSlpXOUxORFpMSi9yUFBLMSs1QnpqTnozMVpERjdXUmxQWHpZM05TNGdTNGNIM3JnTjlHb0V1QmRLcTNtClVmZlZiN1FnUGM3TS9zNDAyanluSVNNNlBYYmhjUnRRcXpqNnVvc05EYjVxcS9GMGVDV3NWYmViUUVKdldrb1IKZW4va043ejlGUER4Tmd6VDkxb1dQd2s9Ci0tLS0tRU5EIFBSSVZBVEUgS0VZLS0tLS0K"
    # Additional production environment variables from .env.production
    - name: BASE_URL
      value: "https://aiglossarypro.com"
    - name: GUMROAD_APPLICATION_ID
      value: "t1jnuDQ_BJI-dWyunbvD9yPwgzQIUNdwXds5H0ZlFlE"
    - name: GUMROAD_APPLICATION_SECRET
      value: "aXLCHgNt6XZgKp0jqIxqQTidFuAHAvKygNqeuXGXSyw"
    - name: GUMROAD_ACCESS_TOKEN
      value: "RPI41H6oBsDXr6mGAwCuiAC3N6dNld4XfyVX7Y0_ghE"
    - name: EMAIL_ENABLED
      value: "true"
    - name: RESEND_API_KEY
      value: "re_hL93cV1B_C1WK1MmZQ6bkcEBi5SM6WuS9"
    # OPENAI_API_KEY - Add via AWS Console
