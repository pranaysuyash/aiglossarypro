# Gumroad Webhook Setup - Complete Guide

## üéØ Current Status
‚úÖ **Webhook endpoints are implemented and ready**
‚úÖ **Security validation is implemented**
‚úÖ **Test scripts are available**
‚ùå **Production configuration needed**

## üîß What's Already Implemented

### Webhook Endpoints
- **Primary endpoints**: `/api/webhooks/gumroad/`
- **Sale webhook**: `/api/webhooks/gumroad/sale`
- **Refund webhook**: `/api/webhooks/gumroad/refund`
- **Dispute webhook**: `/api/webhooks/gumroad/dispute`
- **Cancellation webhook**: `/api/webhooks/gumroad/cancellation`
- **Health check**: `/api/webhooks/gumroad/health`

### Legacy Endpoint (also available)
- **Old webhook**: `/api/gumroad/webhook`

### Test Endpoints (Development only)
- **Test sale**: `/api/webhooks/gumroad/test-sale`
- **Test refund**: `/api/webhooks/gumroad/test-refund`

## üöÄ Production Setup Steps

### Step 1: Configure Gumroad Dashboard
1. Log in to [Gumroad](https://gumroad.com)
2. Go to **Settings** ‚Üí **Advanced** ‚Üí **Webhooks**
3. Click **Add Webhook**
4. Add these webhook URLs:
   ```
   Sale: https://aiglossarypro.com/api/webhooks/gumroad/sale
   Refund: https://aiglossarypro.com/api/webhooks/gumroad/refund
   Dispute: https://aiglossarypro.com/api/webhooks/gumroad/dispute
   Cancellation: https://aiglossarypro.com/api/webhooks/gumroad/cancellation
   ```
5. **Copy the webhook secret** generated by Gumroad

### Step 2: Add to Production Environment
Add this to your `.env.production`:
```bash
GUMROAD_WEBHOOK_SECRET=your_webhook_secret_from_gumroad
```

### Step 3: Test the Configuration
```bash
# Test webhook configuration
npm run test:webhook

# Health check
curl https://aiglossarypro.com/api/webhooks/gumroad/health
```

## üìù What Happens on Purchase

1. **Customer purchases** on Gumroad
2. **Gumroad sends webhook** to your server
3. **Server validates** the signature using `GUMROAD_WEBHOOK_SECRET`
4. **Purchase is recorded** in the database
5. **Customer gets upgraded** to lifetime access
6. **Welcome email sent** via Resend
7. **Support ticket created** if needed

## üîí Security Features

- **Signature verification** for all webhooks
- **Timing-safe comparison** to prevent timing attacks
- **Request validation** with Zod schemas
- **Detailed logging** for debugging
- **Error handling** and recovery

## üß™ Testing

### Test in Development
```bash
# Run development server
npm run dev

# Test a sale
curl -X POST http://localhost:3001/api/webhooks/gumroad/test-sale \
  -H "Content-Type: application/json" \
  -d '{
    "email": "test@example.com",
    "full_name": "Test User",
    "price": 249
  }'
```

### Test in Production
```bash
# Test webhook configuration
npm run test:webhook

# Use Gumroad's test mode
# 1. Create a test product in Gumroad
# 2. Make a test purchase
# 3. Monitor server logs for webhook processing
```

## üìä Monitoring

### Log Locations
- **Webhook logs**: Look for "Gumroad webhook" in server logs
- **Sale processing**: Look for "processSaleWebhook" logs
- **Errors**: Check Sentry for webhook processing errors

### Health Checks
```bash
# Check webhook health
curl https://aiglossarypro.com/api/webhooks/gumroad/health

# Check database connection
curl https://aiglossarypro.com/api/health
```

## üîß Troubleshooting

### Common Issues

**1. Webhook signature validation fails**
- Check that `GUMROAD_WEBHOOK_SECRET` matches Gumroad dashboard
- Verify the webhook URL is correct
- Check server logs for signature validation errors

**2. Purchase not processed**
- Check webhook logs for processing errors
- Verify database connection
- Check if customer email is valid

**3. Email not sent**
- Check Resend configuration
- Verify email templates exist
- Check email service logs

### Debug Commands
```bash
# Check environment variables
echo $GUMROAD_WEBHOOK_SECRET

# Test webhook endpoint
curl -X POST https://aiglossarypro.com/api/webhooks/gumroad/health

# Check server logs
tail -f logs/production.log | grep -i gumroad
```

## üìã Production Checklist

- [ ] Add webhook URLs to Gumroad dashboard
- [ ] Copy webhook secret to `GUMROAD_WEBHOOK_SECRET`
- [ ] Test webhook configuration with `npm run test:webhook`
- [ ] Verify health endpoint responds
- [ ] Test a purchase in Gumroad test mode
- [ ] Monitor logs for successful processing
- [ ] Verify customer gets lifetime access
- [ ] Check welcome email is sent

## üéâ Success Indicators

When everything is working correctly:
- ‚úÖ Health endpoint returns 200 OK
- ‚úÖ Test webhook script passes all checks
- ‚úÖ Purchase webhook logs show "Sale processed successfully"
- ‚úÖ Customer account is upgraded to lifetime access
- ‚úÖ Welcome email is sent to customer

## üìû Support

If you need help:
1. Check the troubleshooting section above
2. Review server logs for error messages
3. Test the webhook configuration script
4. Verify all environment variables are set correctly

## üîó Related Documentation

- [Gumroad API Documentation](https://help.gumroad.com/article/280-webhooks)
- [Production Setup Guide](./PRODUCTION_SETUP_GUIDE.md)
- [Email Service Configuration](./EMAIL_SERVICE_SETUP.md)

Your Gumroad webhook integration is ready for production! üöÄ